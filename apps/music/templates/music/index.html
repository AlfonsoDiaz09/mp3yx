{% load static %}

<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>MP3yx</title>
  <link rel="stylesheet" href="{% static 'music/styles.css' %}">
</head>

<body>
  <div class="container">
    <h1>ğŸµ MP3yx Downloader</h1>

    <div id="groups"></div>

    <button class="btn-primary" onclick="addGroup()">â• Agregar carpeta</button>

    <button class="btn-success" onclick="download()">â¬‡ Descargar MP3</button>
  </div>

  <script>
    const groups = [];

    function addGroup() {
      groups.push({ folder: "", links: [] });
      render();
    }

    function addLink(index) {
      const input = document.getElementById(`link-${index}`);
      const value = input.value.trim();

      if (!value) {
        alert("Link vacÃ­o");
        return;
      }

      groups[index].links.push(value);
      input.value = "";
      render();
    }

    function removeLink(groupIndex, linkIndex) {
      groups[groupIndex].links.splice(linkIndex, 1);
      render();
    }

    function render() {
      if (groups.length === 0) {
        groups.push({ folder: "Carpeta", links: [] });
      }

      const container = document.getElementById("groups");
      container.innerHTML = "";

      groups.forEach((group, i) => {
        container.innerHTML += `
        <div class="group">
          <div class="group-header">
            <input 
              placeholder="Nombre de la carpeta"
              value="${group.folder}"
              onchange="groups[${i}].folder = this.value"
            />
          </div>

          <div class="group-header">
            <input id="link-${i}" placeholder="Pega el link de YouTube" />
            <button class="btn-secondary" onclick="addLink(${i})">Agregar</button>
          </div>

          <ul>
            ${group.links
            .map(
              (link, j) => `
                    <li style="display:flex; gap:8px; align-items:center;">
                    <span style="flex:1">${link}</span>
                    <button 
                        onclick="removeLink(${i}, ${j})"
                        style="
                        background:#ef4444;
                        color:white;
                        border:none;
                        border-radius:6px;
                        padding:4px 8px;
                        cursor:pointer;
                        "
                    >
                        âŒ
                    </button>
                    </li>
                `
            )
            .join("")}
            </ul>
        </div>
      `;
      });
    }

    function download() {
      if (groups.length === 0) {
        alert("Agrega al menos una carpeta");
        return;
      }

      fetch("/music/download/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ groups })
      })
        .then(res => {
          if (!res.ok) throw new Error();
          return res.blob();
        })
        .then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "music.zip";
          a.click();
        })
        .catch(() => alert("Error al descargar"));
    }

    function getCookie(name) {
      return document.cookie
        .split("; ")
        .find(row => row.startsWith(name))
        ?.split("=")[1];
    }

    render();
  </script>

</body>

</html>